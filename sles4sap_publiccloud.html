<?xml version="1.0" ?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<title>lib/sles4sap_publiccloud.pm</title>
<meta http-equiv="content-type" content="text/html; charset=utf-8" />
<link rel='stylesheet' href='./style.css' />
</head>

<body>



<ul id="index"><li><a href="./index.html"><i>&lt;= Back to file list</i></a></li>
  <li>
    <ul>
      <li><a href="#run_cmd-run_cmd-cmd-command-runas-user-timeout-60">run_cmd run_cmd(cmd =&gt; &#39;command&#39;, [runas =&gt; &#39;user&#39;, timeout =&gt; 60]);</a></li>
      <li><a href="#get_promoted_hostname-get_promoted_hostname">get_promoted_hostname() get_promoted_hostname();</a></li>
      <li><a href="#sles4sap_cleanup">sles4sap_cleanup</a></li>
      <li><a href="#get_hana_topology-Parses-command-output-returns-hash-of-hashes-containing-values-for-each-host">get_hana_topology Parses command output, returns hash of hashes containing values for each host.</a></li>
      <li><a href="#is_hana_online-is_hana_online-timeout-120-wait_for_start-false">is_hana_online is_hana_online([timeout =&gt; 120, wait_for_start =&gt; &#39;false&#39;]);</a></li>
      <li><a href="#is_hana_resource_running-is_hana_resource_running-timeout-60">is_hana_resource_running is_hana_resource_running([timeout =&gt; 60]);</a></li>
      <li><a href="#stop_hana-stop_hana-timeout-timeout-method-method">stop_hana stop_hana([timeout =&gt; $timeout, method =&gt; $method]);</a></li>
      <li><a href="#start_hana-start_hana-timeout-60">start_hana start_hana([timeout =&gt; 60]);</a></li>
      <li><a href="#cleanup_resource-cleanup_resource-timeout-60">cleanup_resource cleanup_resource([timeout =&gt; 60]);</a></li>
      <li><a href="#check_takeover-check_takeover">check_takeover check_takeover();</a></li>
      <li><a href="#enable_replication-enable_replication">enable_replication enable_replication();</a></li>
      <li><a href="#get_replication_info-get_replication_info">get_replication_info get_replication_info();</a></li>
      <li><a href="#get_promoted_instance-get_promoted_instance">get_promoted_instance get_promoted_instance();</a></li>
      <li><a href="#wait_for_sync-wait_for_sync-timeout-timeout">wait_for_sync wait_for_sync([timeout =&gt; $timeout]);</a></li>
      <li><a href="#wait_for_pacemaker-wait_for_pacemaker-timeout-timeout">wait_for_pacemaker wait_for_pacemaker([timeout =&gt; $timeout]);</a></li>
      <li><a href="#change_sbd_service_timeout-self-change_sbd_service_timeout-timeout-timeout">change_sbd_service_timeout $self-&gt;change_sbd_service_timeout(timeout =&gt; $timeout);</a></li>
      <li><a href="#setup_sbd_delay_publiccloud-self-setup_sbd_delay_publiccloud">setup_sbd_delay_publiccloud $self-&gt;setup_sbd_delay_publiccloud();</a></li>
      <li><a href="#sbd_delay_formula-self-sbd_delay_formula">sbd_delay_formula $self-&gt;sbd_delay_formula();</a></li>
      <li><a href="#cloud_file_content_replace-cloud_file_content_replace-filename-search_pattern-replace_with">cloud_file_content_replace cloud_file_content_replace($filename, $search_pattern, $replace_with);</a></li>
      <li><a href="#create_instance_data">create_instance_data</a></li>
      <li><a href="#deployment_name">deployment_name</a></li>
      <li><a href="#delete_network_peering">delete_network_peering</a></li>
      <li><a href="#create_ansible_playbook_list">create_ansible_playbook_list</a>
        <ul>
          <li><a href="#azure_fencing_agents_playbook_args">azure_fencing_agents_playbook_args</a></li>
        </ul>
      </li>
      <li><a href="#get_hana_site_names">get_hana_site_names</a></li>
      <li><a href="#create_hana_vars_section">create_hana_vars_section</a></li>
      <li><a href="#display_full_status">display_full_status</a></li>
      <li><a href="#list_cluster_nodes">list_cluster_nodes</a></li>
      <li><a href="#get_hana_database_status">get_hana_database_status</a></li>
      <li><a href="#is_hana_database_online">is_hana_database_online</a></li>
      <li><a href="#is_primary_node_online">is_primary_node_online</a></li>
      <li><a href="#pacemaker_version">pacemaker_version</a></li>
      <li><a href="#saphanasr_showAttr_version">saphanasr_showAttr_version</a></li>
      <li><a href="#wait_for_zypper">wait_for_zypper</a></li>
    </ul>
  </li>
</ul><h1>lib/sles4sap_publiccloud.pm</h1>

<h2 id="run_cmd-run_cmd-cmd-command-runas-user-timeout-60">run_cmd run_cmd(cmd =&gt; &#39;command&#39;, [runas =&gt; &#39;user&#39;, timeout =&gt; 60]);</h2>

<pre><code>Runs a command C&lt;cmd&gt; via ssh in the given VM and log the output.
All commands are executed through C&lt;sudo&gt;.
If &#39;runas&#39; defined, command will be executed as specified user,
otherwise it will be executed as root.</code></pre>

<h2 id="get_promoted_hostname-get_promoted_hostname">get_promoted_hostname() get_promoted_hostname();</h2>

<pre><code>Checks and returns hostname of HANA promoted node according to crm shell output.</code></pre>

<h2 id="sles4sap_cleanup">sles4sap_cleanup</h2>

<pre><code>Clean up Network peering and qesap deployment</code></pre>

<h2 id="get_hana_topology-Parses-command-output-returns-hash-of-hashes-containing-values-for-each-host">get_hana_topology Parses command output, returns hash of hashes containing values for each host.</h2>

<h2 id="is_hana_online-is_hana_online-timeout-120-wait_for_start-false">is_hana_online is_hana_online([timeout =&gt; 120, wait_for_start =&gt; &#39;false&#39;]);</h2>

<pre><code>Check if hana DB is online. Define &#39;wait_for_start&#39; to wait for DB to start.</code></pre>

<h2 id="is_hana_resource_running-is_hana_resource_running-timeout-60">is_hana_resource_running is_hana_resource_running([timeout =&gt; 60]);</h2>

<pre><code>Checks if resource msl_SAPHana_* is running on given node.</code></pre>

<h2 id="stop_hana-stop_hana-timeout-timeout-method-method">stop_hana stop_hana([timeout =&gt; $timeout, method =&gt; $method]);</h2>

<pre><code>Stops HANA database using default or specified method.
&quot;stop&quot; - stops database using &quot;HDB stop&quot; command.
&quot;kill&quot; - kills database processes using &quot;HDB -kill&quot; command.
&quot;crash&quot; - crashes entire os using &quot;/proc-sysrq-trigger&quot; method.</code></pre>

<h2 id="start_hana-start_hana-timeout-60">start_hana start_hana([timeout =&gt; 60]);</h2>

<pre><code>Start HANA DB using &quot;HDB start&quot; command</code></pre>

<h2 id="cleanup_resource-cleanup_resource-timeout-60">cleanup_resource cleanup_resource([timeout =&gt; 60]);</h2>

<pre><code>Cleanup resource &#39;msl_SAPHana_*&#39;, wait for DB start automatically.</code></pre>

<h2 id="check_takeover-check_takeover">check_takeover check_takeover();</h2>

<pre><code>Checks takeover status and waits for finish until successful or reaches timeout.</code></pre>

<h2 id="enable_replication-enable_replication">enable_replication enable_replication();</h2>

<pre><code>Enables replication on fenced database. Database needs to be offline.</code></pre>

<h2 id="get_replication_info-get_replication_info">get_replication_info get_replication_info();</h2>

<pre><code>Parses &quot;hdbnsutil -sr_state&quot; command output.
Returns hash of found values converted to lowercase and replaces spaces to underscores.</code></pre>

<h2 id="get_promoted_instance-get_promoted_instance">get_promoted_instance get_promoted_instance();</h2>

<pre><code>Retrieves hostname from currently promoted (Master) database and returns instance data from $self-&gt;{instances}.</code></pre>

<h2 id="wait_for_sync-wait_for_sync-timeout-timeout">wait_for_sync wait_for_sync([timeout =&gt; $timeout]);</h2>

<pre><code>Wait for replica site to sync data with primary.
Checks &quot;SAPHanaSR-showAttr&quot; output and ensures replica site has &quot;sync_state&quot; &quot;SOK &amp;&amp; PRIM&quot; and no SFAIL.
Continue after expected output matched three times continually to make sure cluster is synced.</code></pre>

<h2 id="wait_for_pacemaker-wait_for_pacemaker-timeout-timeout">wait_for_pacemaker wait_for_pacemaker([timeout =&gt; $timeout]);</h2>

<pre><code>Checks status of pacemaker via systemd &#39;is-active&#39; command an waits for startup.</code></pre>

<h2 id="change_sbd_service_timeout-self-change_sbd_service_timeout-timeout-timeout">change_sbd_service_timeout $self-&gt;change_sbd_service_timeout(timeout =&gt; $timeout);</h2>

<pre><code>Overrides timeout for sbd systemd service to a value provided by argument.
This is done by creating or changing file &quot;/etc/systemd/system/sbd.service.d/sbd_delay_start.conf&quot;</code></pre>

<h2 id="setup_sbd_delay_publiccloud-self-setup_sbd_delay_publiccloud">setup_sbd_delay_publiccloud $self-&gt;setup_sbd_delay_publiccloud();</h2>

<pre><code>Set (activate or deactivate) SBD_DELAY_START setting in /etc/sysconfig/sbd.
Delay is used in case of cluster VM joining cluster too quickly after fencing operation.
For more information check sbd man page.

Setting is changed via OpenQA parameter: HA_SBD_START_DELAY
Possible values:
&quot;no&quot; - do not set and turn off SBD delay time
&quot;yes&quot; - sets default SBD value which is calculated from a formula
&quot;&lt;number of seconds&gt;&quot; - sets specific delay in seconds

Returns integer representing wait time.</code></pre>

<h2 id="sbd_delay_formula-self-sbd_delay_formula">sbd_delay_formula $self-&gt;sbd_delay_formula();</h2>

<h2 id="cloud_file_content_replace-cloud_file_content_replace-filename-search_pattern-replace_with">cloud_file_content_replace cloud_file_content_replace($filename, $search_pattern, $replace_with);</h2>

<pre><code>Replaces file content direct on PC SUT. Similar to lib/utils.pm file_content_replace()</code></pre>

<h2 id="create_instance_data">create_instance_data</h2>

<pre><code>Create and populate a list of publiccloud::instance and publiccloud::provider compatible
class instances.</code></pre>

<h2 id="deployment_name">deployment_name</h2>

<pre><code>Return a string to be used as value for the deployment_name variable
in the qe-sap-deployment.</code></pre>

<h2 id="delete_network_peering">delete_network_peering</h2>

<pre><code>Delete network peering between SUT created with qe-sa-deployment
and the IBS Mirror. Function is generic over all the Cloud Providers</code></pre>

<h2 id="create_ansible_playbook_list">create_ansible_playbook_list</h2>

<pre><code>Detects HANA/HA scenario from function arguments and returns a list of ansible playbooks to include
in the &quot;ansible: create:&quot; section of config.yaml file.</code></pre>

<dl>

<dt id="HA_ENABLED---Enable-the-installation-of-HANA-and-the-cluster-configuration"><b>HA_ENABLED</b> - Enable the installation of HANA and the cluster configuration</dt>
<dd>

</dd>
<dt id="REGISTRATION---select-registration-mode-possible-values-are-registercloudguest-default-suseconnect-noreg-QESAP_SCC_NO_REGISTER-skips-scc-registration-via-ansible"><b>REGISTRATION</b> - select registration mode, possible values are * registercloudguest (default) * suseconnect * noreg &quot;QESAP_SCC_NO_REGISTER&quot; skips scc registration via ansible</dt>
<dd>

</dd>
<dt id="FENCING---select-fencing-mechanism"><b>FENCING</b> - select fencing mechanism</dt>
<dd>

</dd>
</dl>

<h3 id="azure_fencing_agents_playbook_args">azure_fencing_agents_playbook_args</h3>

<pre><code>azure_fencing_agents_playbook_args(
    spn_application_id=&gt;$spn_application_id,
    spn_application_password=&gt;$spn_application_password
);

Collects data and creates string of arguments that can be supplied to playbook.
spn_application_id - application ID that allows API access for STONITH device
spn_application_password - password provided for application ID above</code></pre>

<h2 id="get_hana_site_names">get_hana_site_names</h2>

<pre><code>Get primary and secondary site name.
This information is both needed to configure the qe-sap-deployment
and later in the test when calling `hdbnsutil -sr_register`.
This function mostly read the information from job settings
HANA_PRIMARY_SITE and HANA_SECONDARY_SITE, so main reason to have
it behind a function is to have coherent defaults.</code></pre>

<h2 id="create_hana_vars_section">create_hana_vars_section</h2>

<pre><code>Detects HANA/HA scenario from openQA variables and creates &quot;terraform: variables:&quot; section in config.yaml file.</code></pre>

<h2 id="display_full_status">display_full_status</h2>

<pre><code>$self-&gt;display_full_status()

Displays most useful debugging info about cluster status, database status within a &#39;record_info&#39; test entry.</code></pre>

<h2 id="list_cluster_nodes">list_cluster_nodes</h2>

<pre><code>$self-&gt;list_cluster_nodes()

Returns list of hostnames that are part of a cluster using crm shell command from one of the cluster nodes.</code></pre>

<h2 id="get_hana_database_status">get_hana_database_status</h2>

<pre><code>Run a query to the hana database, parses &quot;hdbsql&quot; command output and check if the connection still is alive.
Returns 1 if the response from hana database is online, 0 otherwise</code></pre>

<h2 id="is_hana_database_online">is_hana_database_online</h2>

<pre><code>Setup a timeout and check the hana database status is offline and there is not connection.
If the connection still is online run a wait and try again to get the status.
Returns 1 if the output of the hana database is online, 0 means that hana database is offline</code></pre>

<dl>

<dt id="TIMEOUT---default-900"><b>TIMEOUT</b> - default 900</dt>
<dd>

</dd>
<dt id="TOTAL_CONSECUTIVE_PASSES---default-5"><b>TOTAL_CONSECUTIVE_PASSES</b> - default 5</dt>
<dd>

</dd>
</dl>

<h2 id="is_primary_node_online">is_primary_node_online</h2>

<pre><code>Check if primary node in a hana cluster is offline.
Returns if primary node status is offline with 0 and 1 online</code></pre>

<h2 id="pacemaker_version">pacemaker_version</h2>

<pre><code>Returns the pacemaker version</code></pre>

<h2 id="saphanasr_showAttr_version">saphanasr_showAttr_version</h2>

<pre><code>Returns the SAPHanaSR-showattr version</code></pre>

<h2 id="wait_for_zypper">wait_for_zypper</h2>

<pre><code>The function attempts to run &#39;zypper ref&#39; to check for a lock. If Zypper is locked, it waits for a specified delay before retrying.
Returns normally if Zypper is not locked or dies after a maximum number of retries if Zypper remains locked.</code></pre>

<dl>

<dt id="instance---The-instance-object-on-which-the-Zypper-command-is-executed.-This-object-must-have-the-run_ssh_command-method-implemented"><b>$instance</b> - The instance object on which the Zypper command is executed. This object must have the run_ssh_command method implemented.</dt>
<dd>

</dd>
<dt id="MAX_RETRIES---The-maximum-number-of-times-the-function-will-retry-checking-if-Zypper-is-locked.-Default-is-10"><b>MAX_RETRIES</b> - The maximum number of times the function will retry checking if Zypper is locked. Default is 10.</dt>
<dd>

</dd>
<dt id="RETRY_DELAY---The-number-of-seconds-to-wait-between-retries.-Default-is-20-seconds"><b>RETRY_DELAY</b> - The number of seconds to wait between retries. Default is 20 seconds.</dt>
<dd>

</dd>
<dt id="TIMEOUT---The-number-of-seconds-to-wait-before-aborting-zypper-ref"><b>TIMEOUT</b> - The number of seconds to wait before aborting zypper ref</dt>
<dd>

</dd>
<dt id="runas---If-runas-defined-command-will-be-executed-as-specified-user-otherwise-it-will-be-executed-as-cloudadmin"><b>runas</b> - If &#39;runas&#39; defined, command will be executed as specified user, otherwise it will be executed as cloudadmin.</dt>
<dd>

</dd>
</dl>


</body>

</html>


