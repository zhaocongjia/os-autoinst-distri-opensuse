<?xml version="1.0" ?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<title>lib/filesystem_utils.pm</title>
<meta http-equiv="content-type" content="text/html; charset=utf-8" />
<link rel='stylesheet' href='./style.css' />
</head>

<body>



<ul id="index"><li><a href="./index.html"><i>&lt;= Back to file list</i></a></li>
  <li>
    <ul>
      <li><a href="#str_to_mb">str_to_mb</a></li>
      <li><a href="#parted_print">parted_print</a></li>
      <li><a href="#partition_num_by_start_end">partition_num_by_start_end</a></li>
      <li><a href="#partition_num_by_type">partition_num_by_type</a></li>
      <li><a href="#free_space">free_space</a></li>
      <li><a href="#mountpoint_to_partition">mountpoint_to_partition</a></li>
      <li><a href="#partition_table">partition_table</a></li>
      <li><a href="#get_partition_table_via_blkid">get_partition_table_via_blkid</a></li>
      <li><a href="#create_partition">create_partition</a></li>
      <li><a href="#remove_partition">remove_partition</a></li>
      <li><a href="#format_partition">format_partition</a></li>
      <li><a href="#df_command">df_command</a></li>
      <li><a href="#get_partition_size">get_partition_size</a></li>
      <li><a href="#get_used_partition_space">get_used_partition_space</a></li>
      <li><a href="#is_lsblk_able_to_display_mountpoints">is_lsblk_able_to_display_mountpoints</a></li>
      <li><a href="#lsblk_command">lsblk_command</a></li>
      <li><a href="#create_lsblk_validation_test_data">create_lsblk_validation_test_data</a></li>
      <li><a href="#validate_lsblk">validate_lsblk</a></li>
      <li><a href="#"></a></li>
    </ul>
  </li>
</ul><h1>lib/filesystem_utils.pm</h1>

<h2 id="str_to_mb">str_to_mb</h2>

<p>Format number and unit from KB, MB, GB, TB to MB</p>

<h2 id="parted_print">parted_print</h2>

<p>parted_print( dev =&gt; &#39;/dev/vda&#39;[, unit =&gt; &#39;GB&#39;]);</p>

<p>Print partition of device <b>dev</b> in unit <b>unit</b>. By default <b>unit</b> is expressed in MB.</p>

<h2 id="partition_num_by_start_end">partition_num_by_start_end</h2>

<p>Get partition number by given device partition start and end</p>

<h2 id="partition_num_by_type">partition_num_by_type</h2>

<p>Get the first parition number by given device and partition/FS type. e.g. extended, xfs Return -1 when not find</p>

<h2 id="free_space">free_space</h2>

<pre><code>free_space( dev =&gt; &#39;/dev/vda&#39;, unit =&gt; &#39;MB&#39;);</code></pre>

<p>Using utility <code>parted</code> and passing named arguments <b>dev</b> and <b>unit</b> in which to perform the operation, get all information (start, end, size) about the bigest free space Return a hash containing start, end and size</p>

<h2 id="mountpoint_to_partition">mountpoint_to_partition</h2>

<p>Get partition by mountpoint, e.g. give /home get /dev/sda3</p>

<h2 id="partition_table">partition_table</h2>

<p>Get partition table information by giving device</p>

<h2 id="get_partition_table_via_blkid">get_partition_table_via_blkid</h2>

<pre><code>get_partition_table_via_blkid(&#39;/dev/vda&#39;);</code></pre>

<p>Get partition table information of giving device using blkid (for example, minimal role does not install parted)</p>

<h2 id="create_partition">create_partition</h2>

<p>Create a new partition by giving device, partition type and partition size part_type (extended|logical|primary)</p>

<h2 id="remove_partition">remove_partition</h2>

<p>Remove a partition by given partition name, e.g /dev/sdb5</p>

<h2 id="format_partition">format_partition</h2>

<pre><code>format_partition($partition, $filesystem [, options =&gt; $options] );</code></pre>

<p>Format partition to target filesystem. The optional value <code>$options</code> is &#39;-f&#39; as default.</p>

<h2 id="df_command">df_command</h2>

<p>Returns the value of the &quot;df -h&quot; output in given column, for a given partition</p>

<pre><code>df_command([partition=&gt;$partition , column=&gt; $column])</code></pre>

<h2 id="get_partition_size">get_partition_size</h2>

<p>Return the value of the defined partition size</p>

<pre><code>get_partition_size($partition)</code></pre>

<h2 id="get_used_partition_space">get_used_partition_space</h2>

<p>Returns the value of used space of the defined partition</p>

<pre><code>get_used_partition_space($partition)</code></pre>

<h2 id="is_lsblk_able_to_display_mountpoints">is_lsblk_able_to_display_mountpoints</h2>

<pre><code>is_lsblk_able_to_display_mountpoints();</code></pre>

<p>Runs utility <code>lsblk</code> using flag --help to retrieve to check for one specific column &#39;MOUNTPOINTS&#39;.</p>

<p>From version util-linux-systemd-2.37 lsblk include new column MOUNTPOINTS with all the mountpoints including all the subvolumes in a btrfs system and in this case existing column MOUNTPOINT does not contain the primary mountpoint for the partition, the first mounted, instead contains the most recent one mounted. Therefore we need to workaround this issue. Please check bsc#1192996 for further info.</p>

<h2 id="lsblk_command">lsblk_command</h2>

<pre><code>my $json = lsblk_command(output =&gt; $output);</code></pre>

<p>Runs utility <code>lsblk</code> using flag -J to retrieve json and returns decoded json.</p>

<p>Named argument <b>output</b> specifies a comma-separated list of columns selected for the output.</p>

<h2 id="create_lsblk_validation_test_data">create_lsblk_validation_test_data</h2>

<pre><code>my $validation_test_data = create_lsblk_validation_test_data(
    device =&gt; $dev, has_mountpoints_col =&gt; 1);</code></pre>

<p>Converts test data to test data adapted for validation using <code>lsblk</code>.</p>

<p>For the device passed converts its test data to corresponding lsblk columns if available in the mapping of this function. Returns the following hash ref structure: { &lt;lsblk_col_name_1&gt; =&gt; { test_data_name =&gt; &lt;test_data_col_name&gt;, value =&gt; &lt;value&gt; } &lt;lsblk_col_name_2&gt; =&gt; { ... } };</p>

<p>Named argument <b>device</b> specifies a block device Named argument <b>has_mountpoints_col</b> indicates whether version of <code>lsblk</code> used contains new MOUNTPOINTS column including all subvolumes mountpoints or not.</p>

<h2 id="validate_lsblk">validate_lsblk</h2>

<pre><code>$errors .= validate_lsblk(device =&gt; $disk, type =&gt; &#39;disk&#39;);</code></pre>

<p>Validates test data using <code>lsblk</code> and returns a summary of all errors found.</p>

<p><b>device</b> represents the device which is used to get output from <code>lsblk</code> command. Use common structure in test data for partitioning, for example:</p>

<p>disks: - name: vda table_type: gpt allowed_unpartitioned: 0.00GB partitions: - name: vda1 formatting_options: should_format: 1 filesystem: xfs mounting_options: should_mount: 1 mount_point: / ...</p>

<p><b>type</b> represents the type of device. Valid values: &#39;disk&#39; and &#39;part&#39;; <b>has_mountpoints_col</b> indicates whether version of <code>lsblk</code> used contains new MOUNTPOINTS column including all subvolumes mountpoints or not.</p>

<p>Returns string with all found errors.</p>

<h2 id=""></h2>

<p>Generate xfstests subtests list This function translate test range to single tests, with xfstests test name format. Input an parameter with list of subtest name, Return a hash of test list. e.g. generate &quot;xfs/001-003,xfs/005&quot; into &quot;{xfs/001 =&gt; 1, xfs/002 =&gt; 1, xfs/003 =&gt; 1, xfs/005 =&gt; 1}&quot;</p>


</body>

</html>


